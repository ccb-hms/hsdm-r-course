---
title: "Week 5: Exploring survey data"
author: "Center for Computational Biomedicine"
format: 
  html: default
code-annotations: select
---

```{r}
#| output: false
library(tidyverse)
library(survey)
library(DT)
library(flextable)
library(officer)
```

# Data
Let's go back to the raw nhanes data, just after we combined the three years. 

```{r}
load("nhanes_beheshti_data.RData")
tib_d <- as_tibble(base_df_d)
tib_e <- as_tibble(base_df_e)
tib_f <- as_tibble(base_df_f)

tib_e <- rename(tib_e, DMDBORN = DMDBORN2)
tib_f <- rename(tib_f, DMDBORN = DMDBORN2)

# Combine all years together
tib_all <- tib_d %>%
  bind_rows(tib_e) %>%
  bind_rows(tib_f)
all_nhanes <- tib_all
```


# Re-doing a analysis

We need to keep the entire dataset in order to properly employ survey weights.
Thus, we'll have to redo most of the processing we've done in previous weeks. 
Since we already have the code, we can repeat it here in a single chain of piped
statements. 

```{r}
all_nhanes <- mutate(all_nhanes,
                   # Numeric Variables
                   LBXGLU = as.numeric(LBXGLU),
                   LBXGH = as.numeric(LBXGH),
                   BMXBMI = as.numeric(BMXBMI),
                   WTSAF2YR = as.numeric(WTSAF2YR),
                   WTINT2YR = as.numeric(WTINT2YR),
                   WTMEC2YR = as.numeric(WTMEC2YR),
                   SDMVPSU = as.numeric(SDMVPSU), 
                   SDMVSTRA = as.numeric(SDMVSTRA),
                   RIDAGEYR = as.numeric(RIDAGEYR),
                   
                   # Basic Categories
                   RIAGENDR = as.factor(RIAGENDR),
                   RIDRETH1 = as.factor(RIDRETH1),
                   DMDBORN = noquote(DMDBORN), # Remove quotes
                   DMDBORN = as.factor(DMDBORN),
                   OHXDECAY = (OHXDECAY == "Yes"),
                   OHXREST = (OHXREST == "Yes"),
                   
                   #Complex Categories
                   diabetes = case_when(
                    is.na(LBXGH) & is.na(LBXGLU) ~ NA,
                    LBXGH >= 6.5 | LBXGLU >= 126 ~ "diabetic",
                    LBXGH >= 5.7 | LBXGLU >= 100 ~ "prediabetic",
                    .default = "nondiabetic"),
                  
                   age.cat = cut(
                    RIDAGEYR,
                    breaks = c(13, 15, 18),
                    include.lowest = TRUE,
                    labels = c("13-15", "16-18")),
                 
                   plasma.glucose.cat = case_when(
                   LBXGLU < 100 ~ "<100 mg/dl",
                   LBXGLU < 126 ~ ">=100 mg/dl and <126 mg/dl", 
                   LBXGLU >= 126 ~ ">=126 mg/dl",
                   .default = NA),
                 
                  hba1c.cat = case_when(
                   LBXGH < 5.7 ~ "<5.7%",
                   LBXGH >= 5.7 ~ ">=5.7% and <6.5%",
                   LBXGH >= 6.5 ~ ">= 6.5%",
                   .default = NA),
                 
                  bmi.cat = case_when( #Technically we should also have an underweight category
                   BMXBMI < 25 ~ "Normal", 
                   BMXBMI < 30 ~ "Overweight",
                   BMXBMI >= 30 ~ "Obese",
                   .default = NA), 
                 
                  family.PIR.cat = case_when(
                   INDFMPIR == "PIR value greater than or equa" ~ ">= 1",
                   INDFMPIR == "Value greater than or equal to" ~ ">= 1",
                   as.numeric(INDFMPIR) >= 1 ~ ">=1",
                   as.numeric(INDFMPIR) < 1 ~ "<1",
                   .default = NA),
                  family.PIR.car = as.numeric(family.PIR.cat) < 1.0,
                 
                  birthplace = case_when(
                   DMDBORN == "Born in 50 US States or Washi" ~ "Within the US",
                   is.na(DMDBORN) ~ NA,
                   DMDBORN == "Don't Know" ~ NA,
                   DMDBORN == "Refused" ~ NA,
                   .default = "Outside the US"),
                  dental.caries = OHXDECAY | OHXREST)
```

# Preparing Survey Analysis

## Removing NA weights

Recall from the reading that we can't have any missing values in the survey design variables. 
Note that since we are using the fasting weights in this analysis, which only include participants
who had fasting glucose measurements taken, a significant proportion of rows will be removed. 

::: callout-warning
Despite the paper saying that they removed those without enough data to determine diabetic status, they did not remove those samples from their weighting calculations here. 
:::

::: {.callout-tip appearance="minimal"}
## Exercise
Remove all rows with `NA` for the main survey design variables; 
`WTMEC2YR`, `SDMVPSU`, and `SDMVSTRA`.

```{r}
wt_nhanes <- all_nhanes %>%
  drop_na(WTMEC2YR, SDMVPSU, SDMVSTRA)
```
:::

## Creating combined survey weights

Currently, our survey weights `WTSAF2YR` are for each 2 year cycle. 
We need to combine them to represent the full 6-year period we are investigating. 
Luckily NHANES has an [official guide](https://wwwn.cdc.gov/nchs/nhanes/tutorials/weighting.aspx) for combining these weights.
It turns out, all we need to do is divide all weights by 3. 

```{r}
wt_nhanes <- wt_nhanes %>%
  mutate(WTMEC6YR = WTMEC2YR * 1/3)
```

## Creating the survey design object

```{r}
nhanes_design <- svydesign(id     = ~SDMVPSU,
                          strata  = ~SDMVSTRA,
                          weights = ~WTMEC6YR,
                          nest    = TRUE,
                          data    = wt_nhanes)
```

Now we can take our data subset from the survey design object. 

```{r}
ado_design <- subset(nhanes_design, RIDAGEYR >= 13 & RIDAGEYR <= 18 & !is.na(OHXDECAY))

#Also make a tibble of this data to analyze
ado_data <- wt_nhanes %>%
  filter(RIDAGEYR >= 13 & RIDAGEYR <= 18) %>% # Gets the 3660 nonedentulous adolescents
  filter(!is.na(OHXDECAY)) %>% # Gets the 3346 with non-NA dental carie variable
  filter(!is.na(diabetes))
```

# Survey Analysis

```{r}
svymean(~RIDAGEYR, ado_design, na.rm = TRUE)
svymean(~RIAGENDR, ado_design, na.rm = TRUE)
```

```{r}
svytable(~age.cat + dental.caries, ado_design)
svymean(~age.cat, ado_design, na.rm = TRUE)
svytable(~RIDRETH1, ado_design)
```

# Creating a summary table

Let's recreate Table 1a. from the Beheshti paper.

# Are summary statistics enough?



```{r}
library(datasets)
datasets::anscombe
```

::: {.callout-tip appearance="minimal"}
:::
