<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="RG">
<meta name="dcterms.date" content="2023-06-26">

<title>Research Design and Analysis - Week 7: Regression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script src="../../site_libs/htmlwidgets-1.6.2/htmlwidgets.js"></script>
<link href="../../site_libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="../../site_libs/datatables-binding-0.29/datatables.js"></script>
<script src="../../site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<link href="../../site_libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="../../site_libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="../../site_libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script>
<link href="../../site_libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="../../site_libs/crosstalk-1.2.0/js/crosstalk.min.js"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Research Design and Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../readings/readings.html" rel="" target="">
 <span class="menu-text">Readings</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../session-materials/sessions.html" rel="" target="" aria-current="page">
 <span class="menu-text">In-Class Materials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../exercises/exercises.html" rel="" target="">
 <span class="menu-text">Exercises</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources/resources.html" rel="" target="">
 <span class="menu-text">NHANES Docker Container</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../resources/resources.html" rel="" target="">
 <span class="menu-text">Resources</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../session-materials/session7/session7.html">Week 7: Regression</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/sessions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sessions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session0/bootcamp-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootcamp Part 1: R Basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session0/bootcamp-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bootcamp Part 2: Starting with Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session2/session2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 2: Markdown and introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session3/session3.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 3: Plotting</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session4/session4.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 4: Preparing Data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session5/session5.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 5: Exploring survey data</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session6/session6.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 6: Statistical tests</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session7/session7.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Week 7: Regression</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../session-materials/session8/session8.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Week 8: Putting it all together</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#load-the-data" id="toc-load-the-data" class="nav-link active" data-scroll-target="#load-the-data">Load the data</a></li>
  <li><a href="#spline-models" id="toc-spline-models" class="nav-link" data-scroll-target="#spline-models">Spline Models</a></li>
  <li><a href="#spline-models-1" id="toc-spline-models-1" class="nav-link" data-scroll-target="#spline-models-1">Spline Models</a></li>
  <li><a href="#sex" id="toc-sex" class="nav-link" data-scroll-target="#sex">Sex</a></li>
  <li><a href="#look-at-more-variables" id="toc-look-at-more-variables" class="nav-link" data-scroll-target="#look-at-more-variables">Look at more variables</a></li>
  <li><a href="#principle-components" id="toc-principle-components" class="nav-link" data-scroll-target="#principle-components">Principle Components</a></li>
  <li><a href="#random-forests" id="toc-random-forests" class="nav-link" data-scroll-target="#random-forests">Random Forests</a></li>
  <li><a href="#back-to-regression" id="toc-back-to-regression" class="nav-link" data-scroll-target="#back-to-regression">Back to Regression</a></li>
  <li><a href="#missing-indicator-approach" id="toc-missing-indicator-approach" class="nav-link" data-scroll-target="#missing-indicator-approach">Missing Indicator Approach</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Week 7: Regression</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>RG </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">June 26, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p><em>Note that this is a copy of NhanesAnalysis.Rmd</em></p>
<section id="load-the-data" class="level2">
<h2 data-anchor-id="load-the-data">Load the data</h2>
<p>There are 6063 observations, some are incomplete and have missing values for some covariates. There are 22 covariates, which have cryptic names and you need to use the meta-data to resolve them. The survey is very complex and typically any analysis requires a substantial amount of reading of the documentation. Here we will guide you past some of the hurdles.</p>
<p>We load up the data and the metadata. In the metadata we have a textual description of the phenotype, the short name, and the target. The target tells us which of the sampled individuals was eligible to answer the question.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>nhanesDataPath <span class="ot">=</span> <span class="st">""</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"d4.rda"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(<span class="st">"metaD.rda"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>DT<span class="sc">::</span><span class="fu">datatable</span>(metaD)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-9b87c8fc62e8330a1b0d" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-9b87c8fc62e8330a1b0d">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20"],["RIDAGEYR","RIAGENDR","RIDRETH1","DMDEDUC2","WTINT2YR","SDMVPSU","SDMVSTRA","INDFMPIR","BPQ050A","BPQ020","BPQ080","BPQ100D","LBDHDD","LBXGH","DIQ010","DIQ050","DIQ070","DIQ160","BMXBMI","LBXTC"],["Age in years at screening","Gender","Race/Hispanic origin","Education level - Adults 20+","Full sample 2 year interview weight","Masked variance pseudo-PSU","Masked variance pseudo-stratum","Ratio of family income to poverty","Now taking prescribed medicine for HBP","Ever told you had high blood pressure","Doctor told you - high cholesterol level","Now taking prescribed medicine","Direct HDL-Cholesterol (mg/dL)","Glycohemoglobin (%)","Doctor told you have diabetes","Taking insulin now","Take diabetic pills to lower blood sugar","Ever told you have prediabetes","Body Mass Index (kg/m**2)","Total Cholesterol (mg/dL)"],["Age in years of the participant at the time of screening. Individuals 80 and over are topcoded at 80 years of age.","Gender of the participant.","Recode of reported race and Hispanic origin information","What is the highest grade or level of school {you have/SP has} completed or the highest degree {you have/s/he has} received?","Full sample 2 year interview weight.","Masked variance unit pseudo-PSU variable for variance estimation","Masked variance unit pseudo-stratum variable for variance estimation","A ratio of family income to poverty guidelines.","HELP AVAILABLE (Are you/Is SP) now taking prescribed medicine","{Have you/Has SP} ever been told by a doctor or other health professional that {you/s/he} had hypertension also called high blood pressure?","{Have you/Has SP} ever been told by a doctor or other health professional that {your/his/her} blood cholesterol level was high?","(Are you/Is SP) now following this advice to take prescribed medicine?","Direct HDL-Cholesterol (mg/dL)","Glycohemoglobin (%)","The next questions are about specific medical conditions. {Other than during pregnancy {have you/has SP}/{Have you/Has SP}} ever been told by a doctor or health professional that {you have/{he/she/SP} has} diabetes or sugar diabetes?","{Is SP/Are you} now taking insulin","{Is SP/Are you} now taking diabetic pills to lower {{his/her}/your} blood sugar? These are sometimes called oral agents or oral hypoglycemic agents.","{Have you/Has SP} ever been told by a doctor or other health professional that {you have/SP has} any of the following: prediabetes impaired fasting glucose impaired glucose tolerance borderline diabetes or that {your/her/his} blood sugar is higher than normal but not high enough to be called diabetes or sugar diabetes?","Body Mass Index (kg/m**2)","Total Cholesterol (mg/dL)"],["Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 20 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 0 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 16 YEARS - 150 YEARS","Both males and females 6 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 1 YEARS - 150 YEARS","Both males and females 12 YEARS - 150 YEARS","Both males and females 2 YEARS - 150 YEARS","Both males and females 6 YEARS - 150 YEARS"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>VariableName<\/th>\n      <th>SASLabel<\/th>\n      <th>EnglishText<\/th>\n      <th>Target<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<p>We will look at the relationship between the variable LBXTC (which is Total Cholesterol in mg/dL measured by a blood draw) and the age of the participant in years.</p>
<div class="cell">
<div class="cell-output-display">
<p><img src="session7_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>And we can see that plotting, over-plotting is a substantial issue here. You might also notice what seems like a lot of data at age 80, this is because any age over 80 was truncated to 80 to prevent reidentification of survey participants. In a complete analysis, this should probably be adjusted for in some way, but we will ignore it for now.</p>
<p>We can try some other methods, such as <code>hexbin</code> plotting and <code>smoothScatter</code></p>
<div class="cell">
<div class="cell-output-display">
<p><img src="session7_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we can see a few outliers - with extremely high serum cholesterol. We get a sense that the trend is not exactly a straight line, but rather a parabola, lower for the young and the old and a bit higher in the middle.</p>
<p>We fit a linear model first.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>lm1 <span class="ot">=</span> <span class="fu">lm</span>(d4<span class="sc">$</span>LBXTC <span class="sc">~</span> d4<span class="sc">$</span>RIDAGEYR)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = d4$LBXTC ~ d4$RIDAGEYR)

Residuals:
    Min      1Q  Median      3Q     Max 
-114.68  -27.95   -2.91   23.34  357.19 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 170.0140     1.4340  118.56   &lt;2e-16 ***
d4$RIDAGEYR   0.3708     0.0285   13.01   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 41.24 on 5689 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.02891,   Adjusted R-squared:  0.02874 
F-statistic: 169.4 on 1 and 5689 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lm1<span class="sc">$</span>fitted.values, lm1<span class="sc">$</span>residuals)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="do">##fit a loess curve</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">=</span> <span class="fu">loess</span>(lm1<span class="sc">$</span>residuals <span class="sc">~</span> lm1<span class="sc">$</span>fitted.values)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>pl <span class="ot">=</span> <span class="fu">predict</span>(l2, <span class="at">newdata=</span><span class="fu">sort</span>(lm1<span class="sc">$</span>fitted.values))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="at">x=</span><span class="fu">sort</span>(lm1<span class="sc">$</span>fitted.values), <span class="at">y=</span>pl, <span class="at">col=</span><span class="st">"blue"</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">col=</span><span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session7_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Notice that both terms in the model are very significant, but that the multiple <span class="math inline">\(R^2\)</span> is only around 2%. So age, in years, is not explaining very much of the variation. But because we have such a large data set, the parameter estimates are found to be significantly different from zero.</p>
</section>
<section id="spline-models" class="level2">
<h2 data-anchor-id="spline-models">Spline Models</h2>
<ul>
<li>when a linear model does not appear sufficient we can try other models.</li>
<li>one choice is to use natural splines, which are very flexible</li>
<li>they are based on B-splines with the previso that the model is linear outside the range of the data</li>
<li>based on the initial analysis, we chose to use df=7, which gives five internal knots when fitting the splines</li>
<li>you have almost 6,000 degrees of freedom here, so using up a few to get a more appropriate fit seems good.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"splines"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>lm2 <span class="ot">=</span> <span class="fu">lm</span>(d4<span class="sc">$</span>LBXTC <span class="sc">~</span> <span class="fu">ns</span>(d4<span class="sc">$</span>RIDAGEYR, <span class="at">df=</span><span class="dv">7</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = d4$LBXTC ~ ns(d4$RIDAGEYR, df = 7))

Residuals:
    Min      1Q  Median      3Q     Max 
-113.43  -26.32   -2.88   22.47  343.31 

Coefficients:
                         Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)               154.799      2.178  71.071  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)1   39.956      3.379  11.826  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)2   32.705      4.074   8.028 1.20e-15 ***
ns(d4$RIDAGEYR, df = 7)3   55.583      3.637  15.283  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)4   42.275      3.725  11.347  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)5   30.111      3.352   8.984  &lt; 2e-16 ***
ns(d4$RIDAGEYR, df = 7)6   41.098      5.758   7.137 1.07e-12 ***
ns(d4$RIDAGEYR, df = 7)7   15.992      2.478   6.453 1.19e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 39.62 on 5683 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.1044,    Adjusted R-squared:  0.1033 
F-statistic: 94.65 on 7 and 5683 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<ul>
<li>we can use standard tools for comparing models</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lm1, lm2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: d4$LBXTC ~ d4$RIDAGEYR
Model 2: d4$LBXTC ~ ns(d4$RIDAGEYR, df = 7)
  Res.Df     RSS Df Sum of Sq      F    Pr(&gt;F)    
1   5689 9674185                                  
2   5683 8922039  6    752146 79.848 &lt; 2.2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</code></pre>
</div>
</div>
<p>Notice also that the multiple <span class="math inline">\(R^2\)</span> went up to about 10%, a pretty substantial increase, suggesting that the curvilinear nature of the relationship is substantial.</p>
<p>The residual standard error also decreased by about 5%.</p>
<p>We have lost the simple explanation that comes from fitting a linear model. We cannot say that your serum cholesterol increases by <span class="math inline">\(a\)</span> units per year, but that model was wrong, so it really shouldn’t be used.</p>
<p>We can use the regression model we fit to make predictions for any one, and these are substantially more accurate.</p>
</section>
<section id="spline-models-1" class="level2">
<h2 data-anchor-id="spline-models-1">Spline Models</h2>
<ul>
<li>even though the regression summary prints out a different row for each spline term, they are not independent variables, and you need to either retain them all, or retain none of them</li>
</ul>
</section>
<section id="sex" class="level2">
<h2 data-anchor-id="sex">Sex</h2>
<ul>
<li>next we might want to start to add other variables and explore the different relationships.</li>
<li>let’s consider sex, for now we will leave out age, and just try to understand what happens with sex</li>
<li>first I will fit the model without an intercept</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> RIAGENDR<span class="dv">-1</span>, <span class="at">data=</span>d4)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ RIAGENDR - 1, data = d4)

Residuals:
    Min      1Q  Median      3Q     Max 
-107.55  -29.55   -3.55   24.21  360.45 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
RIAGENDRMale   184.5534     0.7974   231.4   &lt;2e-16 ***
RIAGENDRFemale 189.7914     0.7692   246.7   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 41.76 on 5689 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.9526,    Adjusted R-squared:  0.9526 
F-statistic: 5.722e+04 on 2 and 5689 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<ul>
<li><p>here we can see the mean for males is a bit higher than for females</p></li>
<li><p>both are significant and notice how large the multiple <span class="math inline">\(R^2\)</span> value is</p></li>
<li><p>this is not a very interesting test - we are asking if the mean is zero, which isn’t even physically possible</p></li>
<li><p>our model is <span class="math display">\[
y_i = \beta_M \cdot 1_{M,i} + \beta_F \cdot 1_{F,i}
\]</span></p></li>
<li><p>where <span class="math inline">\(1_{M,i}\)</span> is 1 if the <span class="math inline">\(i^{th}\)</span> case is male and zero otherwise, similarly for <span class="math inline">\(1_{F,i}\)</span></p></li>
<li><p>instead we ask if the mean for males is different than that for females <span class="math display">\[
y_i = \beta_0 + \beta_1 \cdot 1_{F,i}
\]</span></p></li>
<li><p>so that <span class="math inline">\(E[Y|M] = \beta_0\)</span> and <span class="math inline">\(E[Y|F] = \beta_0 + \beta_1\)</span></p></li>
<li><p><span class="math inline">\(\beta_1\)</span> estimates the difference in mean between male and female</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>lm3 <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> RIAGENDR, <span class="at">data=</span>d4)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lm3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ RIAGENDR, data = d4)

Residuals:
    Min      1Q  Median      3Q     Max 
-107.55  -29.55   -3.55   24.21  360.45 

Coefficients:
               Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    184.5534     0.7974 231.434  &lt; 2e-16 ***
RIAGENDRFemale   5.2380     1.1080   4.728 2.33e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 41.76 on 5689 degrees of freedom
  (372 observations deleted due to missingness)
Multiple R-squared:  0.003913,  Adjusted R-squared:  0.003738 
F-statistic: 22.35 on 1 and 5689 DF,  p-value: 2.327e-06</code></pre>
</div>
</div>
<ul>
<li>now we see an Intercept term (that will be the overall mean)</li>
<li>and the estimate for females is represents how they differ, if it is zero then there is no difference in total cholesterol between men and women</li>
</ul>
</section>
<section id="look-at-more-variables" class="level2">
<h2 data-anchor-id="look-at-more-variables">Look at more variables</h2>
<ul>
<li>now we will put together a set of features (variables) that we are interested in</li>
<li>for simplicity we only keep partipants for which we have all the data</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>ivars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"RIDAGEYR"</span>, <span class="st">"RIAGENDR"</span>, <span class="st">"RIDRETH1"</span>, <span class="st">"DMDEDUC2"</span>, <span class="st">"INDFMPIR"</span>, <span class="st">"LBDHDD"</span>, <span class="st">"LBXGH"</span>, <span class="st">"BMXBMI"</span>, <span class="st">"LBXTC"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>d4sub <span class="ot">=</span> d4[,ivars]</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>compCases <span class="ot">=</span> <span class="fu">apply</span>(d4sub, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>cC <span class="ot">=</span> compCases<span class="sc">==</span><span class="dv">0</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>d4sub <span class="ot">=</span> d4sub[cC,]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(d4sub)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4592    9</code></pre>
</div>
</div>
<p>##One quick transformation</p>
<ul>
<li>the variable <code>DMDEDUC2</code> is a bit too granular for our purposes</li>
<li>we will modify it to be, less than high school, high school and more than high school</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(d4sub<span class="sc">$</span>DMDEDUC2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
                               Less than 9th grade 
                                               523 
9-11th grade (Includes 12th grade with no diploma) 
                                               506 
            High school graduate/GED or equivalent 
                                              1007 
                         Some college or AA degree 
                                              1391 
                         College graduate or above 
                                              1164 
                                        Don't Know 
                                                 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>dd <span class="ot">=</span> d4sub<span class="sc">$</span>DMDEDUC2</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>dd[dd<span class="sc">==</span><span class="st">"Don't Know"</span>] <span class="ot">=</span> <span class="cn">NA</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>eduS <span class="ot">=</span> <span class="fu">ifelse</span>(dd <span class="sc">==</span> <span class="st">"Less than 9th grade"</span> <span class="sc">|</span> dd <span class="sc">==</span><span class="st">"9-11th grade (Includes 12th grade with no diploma)"</span>, <span class="st">"&lt;HS"</span>, <span class="fu">ifelse</span>(dd <span class="sc">==</span> <span class="st">"High school graduate/GED or equivalent"</span>, <span class="st">"HS"</span>, <span class="st">"&gt;HS"</span> ))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co">#stick this into our dataframe</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="co">#and drop the NA</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>d4sub<span class="sc">$</span>eduS <span class="ot">=</span> eduS</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>d4sub <span class="ot">=</span> d4sub[<span class="sc">-</span><span class="fu">which</span>(<span class="fu">is.na</span>(eduS)), ]</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(eduS, dd, <span class="at">useNA =</span> <span class="st">"always"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      dd
eduS   Less than 9th grade 9-11th grade (Includes 12th grade with no diploma)
  &lt;HS                  523                                                506
  &gt;HS                    0                                                  0
  HS                     0                                                  0
  &lt;NA&gt;                   0                                                  0
      dd
eduS   High school graduate/GED or equivalent Some college or AA degree
  &lt;HS                                       0                         0
  &gt;HS                                       0                      1391
  HS                                     1007                         0
  &lt;NA&gt;                                      0                         0
      dd
eduS   College graduate or above Don't Know &lt;NA&gt;
  &lt;HS                          0          0    0
  &gt;HS                       1164          0    0
  HS                           0          0    0
  &lt;NA&gt;                         0          0    1</code></pre>
</div>
</div>
</section>
<section id="principle-components" class="level2">
<h2 data-anchor-id="principle-components">Principle Components</h2>
<ul>
<li>we can take the continuous variables and look at principle components</li>
<li>plotting the first two PCs suggest that these directions are dominated by outliers and that a good step in our analysis might be to remove them</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>cvars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"RIDAGEYR"</span>, <span class="st">"INDFMPIR"</span>, <span class="st">"LBDHDD"</span>, <span class="st">"LBXGH"</span>, <span class="st">"BMXBMI"</span>, <span class="st">"LBXTC"</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>contd4sub<span class="ot">=</span>d4sub[, cvars]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">=</span> <span class="fu">prcomp</span>(contd4sub)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="do">##based on pc plot we have at least 3 outliers that are dominating the first 2 pcs</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>contd4sub <span class="ot">=</span> contd4sub[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1077</span>, <span class="dv">2876</span>, <span class="dv">2933</span>),]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>d4sub <span class="ot">=</span> d4sub[<span class="sc">-</span><span class="fu">c</span>(<span class="dv">1077</span>, <span class="dv">2876</span>, <span class="dv">2933</span>),]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>pcs <span class="ot">=</span> <span class="fu">prcomp</span>(contd4sub)</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>pcvals<span class="ot">=</span>pcs<span class="sc">$</span>x</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="do">##which(abs(pcs$x[,1]) &gt; 300)</span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="do">##which(abs(pcs$x[,2]) &gt; 100)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="random-forests" class="level2">
<h2 data-anchor-id="random-forests">Random Forests</h2>
<ul>
<li>Random Forests are a simple way to get a sense of how important different variables are in predicting a variable of interest.</li>
<li>we will cover Random Forests in some detail in our AI/ML lecture for now we will just apply them</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"randomForest"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>randomForest 4.7-1.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Type rfNews() to see new features/changes/bug fixes.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>rf1 <span class="ot">=</span> <span class="fu">randomForest</span>(LBXTC <span class="sc">~</span> ., <span class="at">proximity=</span><span class="cn">TRUE</span>, <span class="at">data=</span>d4sub)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rf1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="session7_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="back-to-regression" class="level2">
<h2 data-anchor-id="back-to-regression">Back to Regression</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lmF <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> ., <span class="at">data=</span>d4sub)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lmF)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ ., data = d4sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-121.697  -27.614   -3.266   22.511  230.947 

Coefficients: (2 not defined because of singularities)
                                                            Estimate Std. Error
(Intercept)                                                139.83835    5.27657
RIDAGEYR                                                     0.11313    0.03677
RIAGENDRFemale                                               1.21679    1.27112
RIDRETH1Other Hispanic                                      -2.40216    2.19839
RIDRETH1Non-Hispanic White                                  -2.11062    1.90895
RIDRETH1Non-Hispanic Black                                  -8.59043    2.03855
RIDRETH1Other Race - Including Multi-Racial                  1.37260    2.22474
DMDEDUC29-11th grade (Includes 12th grade with no diploma)   1.94689    2.54980
DMDEDUC2High school graduate/GED or equivalent               2.07336    2.29093
DMDEDUC2Some college or AA degree                            1.93297    2.26393
DMDEDUC2College graduate or above                           -1.44617    2.46516
INDFMPIR                                                     1.14015    0.42983
LBDHDD                                                       0.43105    0.03888
LBXGH                                                        2.30193    0.54514
BMXBMI                                                       0.21757    0.09225
eduS&gt;HS                                                           NA         NA
eduSHS                                                            NA         NA
                                                           t value Pr(&gt;|t|)    
(Intercept)                                                 26.502  &lt; 2e-16 ***
RIDAGEYR                                                     3.076  0.00211 ** 
RIAGENDRFemale                                               0.957  0.33849    
RIDRETH1Other Hispanic                                      -1.093  0.27459    
RIDRETH1Non-Hispanic White                                  -1.106  0.26894    
RIDRETH1Non-Hispanic Black                                  -4.214 2.56e-05 ***
RIDRETH1Other Race - Including Multi-Racial                  0.617  0.53728    
DMDEDUC29-11th grade (Includes 12th grade with no diploma)   0.764  0.44518    
DMDEDUC2High school graduate/GED or equivalent               0.905  0.36550    
DMDEDUC2Some college or AA degree                            0.854  0.39325    
DMDEDUC2College graduate or above                           -0.587  0.55747    
INDFMPIR                                                     2.653  0.00802 ** 
LBDHDD                                                      11.088  &lt; 2e-16 ***
LBXGH                                                        4.223 2.46e-05 ***
BMXBMI                                                       2.359  0.01839 *  
eduS&gt;HS                                                         NA       NA    
eduSHS                                                          NA       NA    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 40.05 on 4573 degrees of freedom
Multiple R-squared:  0.04359,   Adjusted R-squared:  0.04067 
F-statistic: 14.89 on 14 and 4573 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>We see that being Non-hispanic black seems to have a pretty big effect, so we might want to just include that, and group all other ethnicities together Education level seems to have little to add, we can drop those.</p>
<p>It might be good to get a sense of the relationship with the poverty level variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a> Black <span class="ot">=</span> <span class="fu">ifelse</span>(d4sub<span class="sc">$</span>RIDRETH1 <span class="sc">==</span> <span class="st">"Non-Hispanic Black"</span>, <span class="st">"B"</span>, <span class="st">"nonB"</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a> ivars <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"RIDAGEYR"</span>, <span class="st">"INDFMPIR"</span>, <span class="st">"LBDHDD"</span>, <span class="st">"LBXGH"</span>, <span class="st">"BMXBMI"</span>, <span class="st">"LBXTC"</span>)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a> d5sub <span class="ot">=</span> <span class="fu">cbind</span>(d4sub[,ivars], Black)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a> lmFx <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> . , <span class="at">data=</span>d5sub)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(lmFx)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ ., data = d5sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-121.851  -27.794   -3.232   22.628  230.533 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 133.22251    5.13242  25.957  &lt; 2e-16 ***
RIDAGEYR      0.10074    0.03558   2.831  0.00465 ** 
INDFMPIR      0.81062    0.37531   2.160  0.03083 *  
LBDHDD        0.43813    0.03643  12.026  &lt; 2e-16 ***
LBXGH         2.38969    0.54074   4.419 1.01e-05 ***
BMXBMI        0.22594    0.08860   2.550  0.01080 *  
BlacknonB     7.32259    1.50452   4.867 1.17e-06 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 40.05 on 4581 degrees of freedom
Multiple R-squared:  0.0415,    Adjusted R-squared:  0.04025 
F-statistic: 33.06 on 6 and 4581 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>Exercise: You can compare the two models using the <code>anova</code> function. Are the two models nested?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lmFx, lmF) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><strong>Exercise:</strong> Plot RIDAGEYR versus INDFMPIR. What do you see in the plot? Does anything cause you concern about fitting a linear model?</p>
</section>
<section id="missing-indicator-approach" class="level2">
<h2 data-anchor-id="missing-indicator-approach">Missing Indicator Approach</h2>
<p>The missing indicator approach may be useful for data where there is a limit of detection, so that values below some lower bound <span class="math inline">\(\alpha_L\)</span> or above some upper bound <span class="math inline">\(\alpha_U\)</span> are set to <span class="math inline">\(\alpha_L\)</span> or to <span class="math inline">\(\alpha_U\)</span> respectively. A similar approach can be used for the Windsorization used for RIDAGEYR variable, where values over 80 are set to 80. We are not proposing using this for other types of missingness, although there is a righ literature and users may want to explore the broader use of this method. However, it is important to realize that often bias or increased variance may obtain, often dependent on untestable assumptions.</p>
<p>The reason that we believe this approach is appropriate for the cases listed is that we actually did measure the variable, and many over variables on those individuals, but we cannot report the exact value for any individual. Hence, one can interpret the indicator as being some form of average over all individuals affected by the reporting limits. It is probably worth noting that these limitations have implications for predication methods. While one in principle could estimate some outcome for an 88 year old person, the data won’t support that prediction. Instead one should ignore the linear predictor for age and use the indicator variable. Chiou <em>et al</em> (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6812630/) provide some rationale for logistic regression and the references therein point to results for linear regression. Groenwold <em>et al</em> (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3414599/) provide advice on more general use of the method to address missing data.</p>
<p>Next let’s try to fix out model to deal with the repeated values in these two variables. Now an important consideration is to try and assess just how to interpret them. For RIDAGEYR the documentation states that anyone over age 80 in the database has their age represented as 80. This is not censoring. The measurements (eg BMI, cholesterol etc.) were all made on a person of some age larger than 80. We just Windsorized their ages, and so these individuals really are not the same as the others, where we are getting accurate age values.</p>
<p>(https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3414599/)</p>
<p>So basically what we want to do is to create a <em>dummy variable</em> for those whose age is reported as 80.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>Age80 <span class="ot">=</span> d5sub<span class="sc">$</span>RIDAGEYR <span class="sc">==</span> <span class="dv">80</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>d6sub<span class="ot">=</span><span class="fu">cbind</span>(d5sub, Age80)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>lmFx2  <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> . <span class="sc">+</span> Age80 , <span class="at">data=</span>d6sub)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(lmFx2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ . + Age80, data = d6sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-124.153  -27.990   -2.893   22.471  233.538 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 131.37007    5.10387  25.739  &lt; 2e-16 ***
RIDAGEYR      0.23620    0.03930   6.011 1.99e-09 ***
INDFMPIR      0.63847    0.37346   1.710 0.087409 .  
LBDHDD        0.43743    0.03619  12.087  &lt; 2e-16 ***
LBXGH         2.08628    0.53854   3.874 0.000109 ***
BMXBMI        0.17431    0.08826   1.975 0.048333 *  
BlacknonB     7.61583    1.49503   5.094 3.64e-07 ***
Age80TRUE   -22.52123    2.85514  -7.888 3.81e-15 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 39.79 on 4580 degrees of freedom
Multiple R-squared:  0.05435,   Adjusted R-squared:  0.05291 
F-statistic: 37.61 on 7 and 4580 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><strong>Exercise:</strong> What changes do you notice in the model fit? Use the anova function to compare <code>lmFx3</code> to <code>lmFx2</code>. How do you interpret the output? <look at="" indfmpir=""></look></p>
<p><strong>Exercise:</strong> Try to fit missing indicator variables for both of the repeated values in the INDFMPIR variable. Then interpret the output.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>Pov5 <span class="ot">=</span> d6sub<span class="sc">$</span>INDFMPIR <span class="sc">==</span> <span class="dv">5</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>Pov0 <span class="ot">=</span> d6sub<span class="sc">$</span>INDFMPIR <span class="sc">==</span> <span class="dv">0</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>d7sub <span class="ot">=</span> <span class="fu">cbind</span>(d6sub, Pov5, Pov0)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>lmFx2  <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> . <span class="sc">+</span> Age80 <span class="sc">+</span> Pov0 <span class="sc">+</span> Pov5, <span class="at">data=</span>d7sub)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(lmFx2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ . + Age80 + Pov0 + Pov5, data = d7sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-124.211  -28.113   -2.924   22.452  233.584 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) 131.71138    5.14836  25.583  &lt; 2e-16 ***
RIDAGEYR      0.23508    0.03937   5.972 2.53e-09 ***
INDFMPIR      0.48519    0.53208   0.912 0.361880    
LBDHDD        0.43724    0.03621  12.076  &lt; 2e-16 ***
LBXGH         2.09263    0.53888   3.883 0.000105 ***
BMXBMI        0.17328    0.08834   1.962 0.049867 *  
BlacknonB     7.60308    1.49565   5.083 3.85e-07 ***
Age80TRUE   -22.49633    2.85926  -7.868 4.47e-15 ***
Pov5TRUE      0.77824    2.26671   0.343 0.731364    
Pov0TRUE     -2.87497    6.20157  -0.464 0.642966    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 39.8 on 4578 degrees of freedom
Multiple R-squared:  0.05441,   Adjusted R-squared:  0.05256 
F-statistic: 29.27 on 9 and 4578 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p>It seems that some of the apparent effect of INDFMPIR seems to be related to the fact that we are not fitting RIDAGEYR properly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a> lmFx3 <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR, <span class="at">df=</span><span class="dv">7</span>)<span class="sc">+</span> INDFMPIR<span class="sc">+</span> LBDHDD<span class="sc">+</span>LBXGH <span class="sc">+</span> BMXBMI <span class="sc">+</span> Black <span class="sc">+</span> Age80 <span class="sc">+</span> Pov0 <span class="sc">+</span> Pov5, <span class="at">data=</span>d7sub)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a> <span class="fu">summary</span>(lmFx3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ ns(RIDAGEYR, df = 7) + INDFMPIR + LBDHDD + 
    LBXGH + BMXBMI + Black + Age80 + Pov0 + Pov5, data = d7sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-107.624  -26.969   -3.422   22.446  235.007 

Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           123.61064    5.67125  21.796  &lt; 2e-16 ***
ns(RIDAGEYR, df = 7)1  29.51675    3.83297   7.701 1.65e-14 ***
ns(RIDAGEYR, df = 7)2  27.22554    4.93196   5.520 3.57e-08 ***
ns(RIDAGEYR, df = 7)3  43.76063    4.41993   9.901  &lt; 2e-16 ***
ns(RIDAGEYR, df = 7)4  27.43607    4.63596   5.918 3.49e-09 ***
ns(RIDAGEYR, df = 7)5  14.40261    4.39131   3.280  0.00105 ** 
ns(RIDAGEYR, df = 7)6  30.58254    7.98665   3.829  0.00013 ***
ns(RIDAGEYR, df = 7)7   8.03699    5.13361   1.566  0.11752    
INDFMPIR               -0.01926    0.52258  -0.037  0.97061    
LBDHDD                  0.45186    0.03551  12.727  &lt; 2e-16 ***
LBXGH                   1.68200    0.53017   3.173  0.00152 ** 
BMXBMI                  0.07783    0.08683   0.896  0.37014    
BlacknonB               8.06440    1.46712   5.497 4.08e-08 ***
Age80TRUE              -7.17874    5.48512  -1.309  0.19068    
Pov0TRUE               -6.50137    6.08383  -1.069  0.28529    
Pov5TRUE               -0.06740    2.22084  -0.030  0.97579    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 38.96 on 4572 degrees of freedom
Multiple R-squared:  0.09487,   Adjusted R-squared:  0.0919 
F-statistic: 31.95 on 15 and 4572 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
</div>
<p><em>Exercise::</em></p>
<p>In the code below, we drop the terms that were not statistically significant in the model and then compare this smaller model to the larger one, above. Interpret the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>lmFx4 <span class="ot">=</span> <span class="fu">lm</span>(LBXTC <span class="sc">~</span> <span class="fu">ns</span>(RIDAGEYR, <span class="at">df=</span><span class="dv">7</span>) <span class="sc">+</span> LBDHDD<span class="sc">+</span>LBXGH<span class="sc">+</span>Black, <span class="at">data=</span>d7sub)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(lmFx4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = LBXTC ~ ns(RIDAGEYR, df = 7) + LBDHDD + LBXGH + 
    Black, data = d7sub)

Residuals:
     Min       1Q   Median       3Q      Max 
-105.937  -26.949   -3.407   22.193  234.664 

Coefficients:
                       Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)           125.94067    4.93936  25.497  &lt; 2e-16 ***
ns(RIDAGEYR, df = 7)1  29.92780    3.81772   7.839 5.60e-15 ***
ns(RIDAGEYR, df = 7)2  27.19534    4.90144   5.548 3.04e-08 ***
ns(RIDAGEYR, df = 7)3  44.60181    4.35736  10.236  &lt; 2e-16 ***
ns(RIDAGEYR, df = 7)4  26.40388    4.50739   5.858 5.02e-09 ***
ns(RIDAGEYR, df = 7)5  17.52411    3.80778   4.602 4.29e-06 ***
ns(RIDAGEYR, df = 7)6  28.18635    7.63846   3.690 0.000227 ***
ns(RIDAGEYR, df = 7)7   2.33978    2.68986   0.870 0.384428    
LBDHDD                  0.44206    0.03402  12.993  &lt; 2e-16 ***
LBXGH                   1.73292    0.52267   3.315 0.000922 ***
BlacknonB               7.88204    1.45294   5.425 6.10e-08 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 38.96 on 4577 degrees of freedom
Multiple R-squared:  0.09412,   Adjusted R-squared:  0.09214 
F-statistic: 47.56 on 10 and 4577 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">anova</span>(lmFx4, lmFx3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Analysis of Variance Table

Model 1: LBXTC ~ ns(RIDAGEYR, df = 7) + LBDHDD + LBXGH + Black
Model 2: LBXTC ~ ns(RIDAGEYR, df = 7) + INDFMPIR + LBDHDD + LBXGH + BMXBMI + 
    Black + Age80 + Pov0 + Pov5
  Res.Df     RSS Df Sum of Sq      F Pr(&gt;F)
1   4577 6946291                           
2   4572 6940552  5    5739.5 0.7562 0.5814</code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>